print("è„šæœ¬åˆå§‹åŒ–å¼€å§‹")
gg.alert("è„šæœ¬åˆ¶ä½œäººï¼šå‘†æ»ä¸¶\næ­¤è„šæœ¬ä»…ä¾›æ•™å­¦ä½œç”¨ä¸”ä¸ºAIåˆ¶ä½œ\nç¦æ­¢è¿›è¡Œå•†ç”¨")

local scriptState = {
    recognizedItems = {},
    searchActive = false,
    settings = {
        flyEnabled = false,
        wallCollision = false,
        infiniteJump = false,
        walkAir = false,
        speedEnabled = false,
        speedMultiplier = 1.0
    }
}

-- ====== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° (ä¸åŸè„šæœ¬ä¸€è‡´) ======
local function enableFly()
    gg.clearResults()
    gg.setRanges(gg.REGION_ANONYMOUS | gg.REGION_C_ALLOC)
    gg.searchNumber("1;5.12099981308", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(count)
        for i, v in ipairs(results) do
            if math.abs(v.value - 5.12099981308) < 0.1 then
                v.value = 999999
                gg.setValues({v})
                break
            end
        end
    end
    gg.clearResults()
    gg.toast("[é£å¤©] å·²å¯ç”¨")
end

local function disableFly()
    gg.clearResults()
    gg.setRanges(gg.REGION_ANONYMOUS | gg.REGION_C_ALLOC)
    gg.searchNumber("999999", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(count)
        for i, v in ipairs(results) do
            v.value = 5.12099981308
            gg.setValues({v})
        end
    end
    gg.clearResults()
    gg.toast("[é£å¤©] å·²ç¦ç”¨")
end

local function enableWallPass()
    gg.clearResults()
    gg.setRanges(gg.REGION_C_ALLOC)
    gg.searchNumber("0.30000001192", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(math.min(count, 10))
        for i, v in ipairs(results) do
            gg.addListItems({[1] = {address = v.address, flags = gg.TYPE_FLOAT, value = 0, freeze = true}})
        end
    end
    gg.toast("[ç©¿å¢™] å·²å¯ç”¨")
end

local function disableWallPass()
    gg.clearResults()
    gg.setRanges(gg.REGION_C_ALLOC)
    gg.searchNumber("0", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(math.min(count, 10))
        for i, v in ipairs(results) do
            v.value = 0.30000001192
            gg.setValues({v})
        end
    end
    gg.clearList()
    gg.toast("[ç©¿å¢™] å·²ç¦ç”¨")
end

local function enableInfiniteJump()
    gg.clearResults()
    gg.setRanges(gg.REGION_ANONYMOUS)
    gg.searchNumber("1;1;1;1::", gg.TYPE_DWORD)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(math.min(count, 100))
        for i, v in ipairs(results) do
            if v.value == 1 then
                gg.addListItems({[1] = {address = v.address, flags = gg.TYPE_DWORD, value = 999999, freeze = true}})
            end
        end
    end
    gg.toast("[æ— é™è·³] å·²å¯ç”¨")
end

local function disableInfiniteJump()
    gg.clearList()
    gg.toast("[æ— é™è·³] å·²ç¦ç”¨")
end

local function enableWalkAir()
    gg.clearResults()
    gg.setRanges(gg.REGION_C_ALLOC)
    gg.searchNumber("-9.8;-9.8;0.5::", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(math.min(count, 20))
        for i, v in ipairs(results) do
            if v.value < -9.7 and v.value > -9.9 then
                gg.addListItems({[1] = {address = v.address, flags = gg.TYPE_FLOAT, value = 0.1, freeze = true}})
            end
        end
    end
    gg.toast("[è¸ç©º] å·²å¯ç”¨")
end

local function disableWalkAir()
    gg.clearResults()
    gg.setRanges(gg.REGION_C_ALLOC)
    gg.searchNumber("0.1", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(math.min(count, 20))
        for i, v in ipairs(results) do
            v.value = -9.8
            gg.setValues({v})
        end
    end
    gg.clearList()
    gg.toast("[è¸ç©º] å·²ç¦ç”¨")
end

local function applySpeedMultiplier(multiplier)
    if multiplier == 1.0 then
        gg.clearResults()
        gg.setRanges(gg.REGION_C_ALLOC)
        gg.searchNumber("100.0;10.0;5.0;2.0;0.5", gg.TYPE_FLOAT)
        local count = gg.getResultCount()
        if count > 0 then
            local results = gg.getResults(math.min(count, 50))
            for i, v in ipairs(results) do
                v.value = 1.0
                gg.setValues({v})
            end
        end
        gg.clearResults()
        return
    end
    -- ç®€åŒ–ç‰ˆé€Ÿåº¦ä¿®æ”¹ï¼ˆåŸç»´æŠ¤çº¿ç¨‹é€»è¾‘è¾ƒå¤æ‚ï¼Œæ­¤å¤„åšä¸€æ¬¡æ€§ä¿®æ”¹ï¼‰
    gg.clearResults()
    gg.setRanges(gg.REGION_C_ALLOC)
    gg.searchNumber("1.0", gg.TYPE_FLOAT)
    local count = gg.getResultCount()
    if count > 0 then
        local results = gg.getResults(math.min(count, 30))
        for i, v in ipairs(results) do
            if math.abs(v.value - 1.0) < 0.01 then
                v.value = multiplier
                gg.setValues({v})
            end
        end
    end
    gg.clearResults()
end

-- ====== ç‰©å“è¯†åˆ«ä¸æ“ä½œç›¸å…³å‡½æ•° ======
local function getCurrentInventory()
    local inventory = {}
    -- è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ¡†æ¶ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®æ¸¸æˆè°ƒæ•´æœç´¢æ–¹æ³•
    gg.clearResults()
    gg.setRanges(gg.REGION_C_ALLOC)
    local searchSuccess, searchError = pcall(function()
        gg.searchNumber("100;200;300::", gg.TYPE_DWORD)
    end)
    if searchSuccess then
        local results = gg.getResults(50)
        for _, v in ipairs(results) do
            local nameAddr = v.address + 0x10
            local name = gg.getString(nameAddr)
            if name and #name > 0 and #name < 50 then
                table.insert(inventory, name)
            end
        end
        gg.clearResults()
    end
    return inventory
end

local function startItemRecognition()
    gg.toast("å¼€å§‹è¯†åˆ«ï¼Œè¯·åœ¨10ç§’å†…æ‹¾å–ç‰©å“...")
    local startTime = os.time()
    local lastInventory = getCurrentInventory() or {}
    local timeout = 10
    
    while os.time() - startTime < timeout do
        gg.sleep(500)
        local currentInventory = getCurrentInventory() or {}
        if #currentInventory > #lastInventory then
            for _, item in ipairs(currentInventory) do
                local found = false
                for _, oldItem in ipairs(lastInventory) do
                    if item == oldItem then
                        found = true
                        break
                    end
                end
                if not found then
                    local choice = gg.alert("å‘ç°æ–°ç‰©å“: " .. item, "åŠ å…¥ç™½åå•", "å¿½ç•¥")
                    if choice == 1 then
                        if #scriptState.recognizedItems >= 2 then
                            gg.alert("ç™½åå•å·²æ»¡ï¼ˆæœ€å¤š2ä¸ªï¼‰")
                        else
                            table.insert(scriptState.recognizedItems, item)
                            gg.toast("å·²æ·»åŠ è‡³ç™½åå•: " .. item)
                            return true
                        end
                    end
                end
            end
        end
        lastInventory = currentInventory
    end
    gg.toast("è¯†åˆ«è¶…æ—¶")
    return false
end

-- ====== èœå•ç•Œé¢å‡½æ•° ======
local function menuMain()
    local choice = gg.choice({
        "ğŸ® äººç‰©åŠŸèƒ½",
        "ğŸ“¦ ç‰©å“è¯†åˆ«ä¸æ“ä½œ",
        "âš™ï¸ è„šæœ¬è®¾ç½®",
        "âŒ é€€å‡ºè„šæœ¬"
    }, nil, "Daixiaohao - æ±¤å§†çŒ«è’é‡æ´¾å¯¹\nå½“å‰ç™½åå•: " .. #scriptState.recognizedItems .. "/2")
    
    if choice == 1 then
        menuCharacter()
    elseif choice == 2 then
        menuItems()
    elseif choice == 3 then
        menuSettings()
    elseif choice == 4 then
        local confirm = gg.alert("ç¡®å®šé€€å‡ºè„šæœ¬ï¼Ÿ", "ç¡®å®š", "å–æ¶ˆ")
        if confirm == 1 then
            gg.toast("è„šæœ¬å·²é€€å‡º")
            os.exit()
        else
            menuMain()
        end
    end
end

local function menuCharacter()
    local statusFly = scriptState.settings.flyEnabled and "âœ…" or "âŒ"
    local statusWall = scriptState.settings.wallCollision and "âœ…" or "âŒ"
    local statusJump = scriptState.settings.infiniteJump and "âœ…" or "âŒ"
    local statusAir = scriptState.settings.walkAir and "âœ…" or "âŒ"
    local statusSpeed = scriptState.settings.speedEnabled and "âœ… " .. scriptState.settings.speedMultiplier .. "x" or "âŒ"
    
    local choice = gg.choice({
        statusFly .. " äººç‰©é£å¤©",
        statusWall .. " äººç‰©ç©¿å¢™",
        statusJump .. " æ— é™åˆ¶è·³è·ƒ",
        statusAir .. " è¸ç©ºè¡Œèµ°",
        statusSpeed .. " æ¸¸æˆåŠ é€Ÿ",
        "â¬…ï¸ è¿”å›ä¸»èœå•"
    }, nil, "äººç‰©åŠŸèƒ½è®¾ç½®")
    
    if choice == 1 then
        scriptState.settings.flyEnabled = not scriptState.settings.flyEnabled
        if scriptState.settings.flyEnabled then
            enableFly()
        else
            disableFly()
        end
        menuCharacter()
    elseif choice == 2 then
        scriptState.settings.wallCollision = not scriptState.settings.wallCollision
        if scriptState.settings.wallCollision then
            enableWallPass()
        else
            disableWallPass()
        end
        menuCharacter()
    elseif choice == 3 then
        scriptState.settings.infiniteJump = not scriptState.settings.infiniteJump
        if scriptState.settings.infiniteJump then
            enableInfiniteJump()
        else
            disableInfiniteJump()
        end
        menuCharacter()
    elseif choice == 4 then
        scriptState.settings.walkAir = not scriptState.settings.walkAir
        if scriptState.settings.walkAir then
            enableWalkAir()
        else
            disableWalkAir()
        end
        menuCharacter()
    elseif choice == 5 then
        menuSpeed()
    elseif choice == 6 then
        menuMain()
    end
end

local function menuSpeed()
    local choice = gg.choice({
        "ğŸš€ å¼€å¯/å…³é—­åŠ é€Ÿ",
        "ğŸ”¢ è®¾ç½®åŠ é€Ÿå€æ•°",
        "â¬…ï¸ è¿”å›ä¸Šä¸€é¡µ"
    }, nil, "å½“å‰å€æ•°: " .. scriptState.settings.speedMultiplier .. "x")
    
    if choice == 1 then
        scriptState.settings.speedEnabled = not scriptState.settings.speedEnabled
        if scriptState.settings.speedEnabled then
            applySpeedMultiplier(scriptState.settings.speedMultiplier)
            gg.toast("[åŠ é€Ÿ] å·²å¯ç”¨ (" .. scriptState.settings.speedMultiplier .. "x)")
        else
            applySpeedMultiplier(1.0)
            gg.toast("[åŠ é€Ÿ] å·²ç¦ç”¨")
        end
        menuSpeed()
    elseif choice == 2 then
        local input = gg.prompt({"è¯·è¾“å…¥åŠ é€Ÿå€æ•° (0.1 - 100.0):"}, {tostring(scriptState.settings.speedMultiplier)}, {"number"})
        if input and input[1] then
            local num = tonumber(input[1])
            if num and num >= 0.1 and num <= 100.0 then
                scriptState.settings.speedMultiplier = num
                if scriptState.settings.speedEnabled then
                    applySpeedMultiplier(num)
                end
                gg.toast("åŠ é€Ÿå€æ•°å·²è®¾ç½®ä¸º: " .. num .. "x")
            else
                gg.toast("è¾“å…¥æ— æ•ˆ")
            end
        end
        menuSpeed()
    elseif choice == 3 then
        menuCharacter()
    end
end

local function menuItems()
    local whitelistText = ""
    if #scriptState.recognizedItems > 0 then
        whitelistText = "\n\nç™½åå•ç‰©å“:"
        for i, item in ipairs(scriptState.recognizedItems) do
            whitelistText = whitelistText .. "\n" .. i .. ". " .. item
        end
    end
    
    local choice = gg.choice({
        "ğŸ” è¯†åˆ«æ–°ç‰©å“",
        "âš¡ å¼€å§‹æ“ä½œç‰©å“",
        "ğŸ—‘ï¸ æ¸…ç©ºç™½åå•",
        "â¬…ï¸ è¿”å›ä¸»èœå•"
    }, nil, "ç‰©å“è¯†åˆ«ä¸æ“ä½œ" .. whitelistText)
    
    if choice == 1 then
        startItemRecognition()
        menuItems()
    elseif choice == 2 then
        if #scriptState.recognizedItems > 0 then
            gg.alert("ç‰©å“æ“ä½œåŠŸèƒ½", "æ­¤åŠŸèƒ½éœ€è¦æ ¹æ®å…·ä½“æ¸¸æˆè°ƒæ•´å†…å­˜æœç´¢é€»è¾‘ã€‚\nå½“å‰ç™½åå•ç‰©å“æ•°: " .. #scriptState.recognizedItems)
        else
            gg.alert("ç™½åå•ä¸ºç©º", "è¯·å…ˆè¯†åˆ«ç‰©å“")
        end
        menuItems()
    elseif choice == 3 then
        if #scriptState.recognizedItems > 0 then
            local confirm = gg.alert("ç¡®å®šæ¸…é™¤æ‰€æœ‰ç™½åå•ç‰©å“ï¼Ÿ", "ç¡®å®š", "å–æ¶ˆ")
            if confirm == 1 then
                scriptState.recognizedItems = {}
                gg.toast("ç™½åå•å·²æ¸…ç©º")
            end
        else
            gg.toast("ç™½åå•å·²ä¸ºç©º")
        end
        menuItems()
    elseif choice == 4 then
        menuMain()
    end
end

local function menuSettings()
    local choice = gg.choice({
        "ğŸ§¹ æ¸…ç†å†…å­˜ç»“æœ",
        "â„¹ï¸ è„šæœ¬ä¿¡æ¯",
        "â¬…ï¸ è¿”å›ä¸»èœå•"
    }, nil, "è„šæœ¬è®¾ç½®")
    
    if choice == 1 then
        gg.clearResults()
        gg.clearList()
        gg.toast("å·²æ¸…ç†å†…å­˜ç»“æœå’Œå†»ç»“åˆ—è¡¨")
        menuSettings()
    elseif choice == 2 then
        gg.alert("è„šæœ¬ä¿¡æ¯", "Daixiaohao - æ±¤å§†çŒ«è’é‡æ´¾å¯¹\nç‰ˆæœ¬: èœå•ç‰ˆ 1.0\nä»…ä¾›æ•™å­¦ä½¿ç”¨\nè¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”")
        menuSettings()
    elseif choice == 3 then
        menuMain()
    end
end

-- ====== è„šæœ¬ä¸»å…¥å£ ======
gg.toast("è„šæœ¬åŠ è½½å®Œæˆ")
while true do
    if gg.isVisible(true) then
        gg.setVisible(false)
        menuMain()
    end
    gg.sleep(100)
end
